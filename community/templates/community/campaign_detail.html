{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ campaign.title }} - EcoLearn{% endblock %}

{% block extra_css %}
<style>
.campaign-hero {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.9), rgba(5, 150, 105, 0.9));
    border-radius: 1rem;
    color: white;
}
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-weight: 600;
    font-size: 0.875rem;
}
.status-ongoing { background: rgba(34, 197, 94, 0.2); color: #16a34a; }
.status-upcoming { background: rgba(59, 130, 246, 0.2); color: #2563eb; }
.status-past { background: rgba(107, 114, 128, 0.2); color: #6b7280; }
.participant-avatar {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    border: 2px solid white;
    margin-left: -0.5rem;
}
.join-form {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    border-radius: 1rem;
    padding: 2rem;
    color: white;
}
.interest-option {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s;
}
.interest-option:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
}
.interest-option.selected {
    background: rgba(255, 255, 255, 0.3);
    border-color: white;
}
.info-card {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-left: 4px solid #10b981;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Breadcrumb -->
        <nav class="mb-8">
            <ol class="flex items-center space-x-2 text-sm text-gray-500">
                <li><a href="{% url 'community:campaigns_list' %}" class="hover:text-blue-600">Campaigns</a></li>
                <li><span class="mx-2">/</span></li>
                <li class="text-gray-900 font-medium">{{ campaign.title }}</li>
            </ol>
        </nav>

        <!-- Campaign Hero -->
        <div class="campaign-hero p-8 mb-8">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="flex-1">
                    <!-- Status Badge -->
                    <div class="mb-4">
                        {% if campaign.is_ongoing %}
                        <span class="status-badge status-ongoing">üü¢ Ongoing Now</span>
                        {% elif campaign.is_upcoming %}
                        <span class="status-badge status-upcoming">üîµ Upcoming</span>
                        {% else %}
                        <span class="status-badge status-past">üìÖ Completed</span>
                        {% endif %}
                    </div>
                    
                    <h1 class="text-4xl font-bold mb-4">{{ campaign.title }}</h1>
                    <p class="text-xl text-green-100 mb-6">{{ campaign.description }}</p>
                    
                    <!-- Key Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-green-100">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üìç</span>
                            <div>
                                <div class="font-semibold">Location</div>
                                <div>{{ campaign.location }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üìÖ</span>
                            <div>
                                <div class="font-semibold">Date & Time</div>
                                <div>{{ campaign.start_date|date:"M d, Y" }} at {{ campaign.start_date|time:"g:i A" }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üè∑Ô∏è</span>
                            <div>
                                <div class="font-semibold">Type</div>
                                <div>{{ campaign.get_campaign_type_display }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üë•</span>
                            <div>
                                <div class="font-semibold">Participants</div>
                                <div>{{ campaign.participant_count }} joined{% if campaign.max_participants %} / {{ campaign.max_participants }}{% endif %}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if campaign.image %}
                <div class="lg:w-1/3">
                    <img src="{{ campaign.image.url }}" alt="{{ campaign.title }}" 
                         class="w-full h-64 lg:h-full object-cover rounded-lg shadow-lg">
                </div>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Campaign Details -->
                <div class="info-card">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Campaign Details</h2>
                    <div class="prose max-w-none">
                        <p class="text-gray-700 leading-relaxed">{{ campaign.description }}</p>
                    </div>
                    
                    {% if campaign.recurrence != 'one_time' %}
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-semibold text-blue-900 mb-2">üîÑ Recurring Campaign</h3>
                        <p class="text-blue-700">
                            This is a {{ campaign.get_recurrence_display|lower }} campaign. 
                            {% if next_campaign %}
                            The next occurrence is scheduled for {{ next_campaign.start_date|date:"M d, Y" }}.
                            {% endif %}
                        </p>
                    </div>
                    {% endif %}
                </div>

                <!-- Schedule & Location -->
                <div class="info-card">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Schedule & Location</h2>
                    <div class="space-y-4">
                        <div class="flex items-start gap-4">
                            <span class="text-2xl">üìÖ</span>
                            <div>
                                <h3 class="font-semibold text-gray-900">Date & Duration</h3>
                                <p class="text-gray-600">
                                    {{ campaign.start_date|date:"l, F d, Y" }}<br>
                                    {{ campaign.start_date|time:"g:i A" }} - {{ campaign.end_date|time:"g:i A" }}
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-start gap-4">
                            <span class="text-2xl">üìç</span>
                            <div>
                                <h3 class="font-semibold text-gray-900">Meeting Point</h3>
                                <p class="text-gray-600">{{ campaign.location }}</p>
                                {% if campaign.latitude and campaign.longitude %}
                                <a href="https://maps.google.com/?q={{ campaign.latitude }},{{ campaign.longitude }}" 
                                   target="_blank" 
                                   class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    üìç View on Google Maps
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if campaign.registration_deadline %}
                        <div class="flex items-start gap-4">
                            <span class="text-2xl">‚è∞</span>
                            <div>
                                <h3 class="font-semibold text-gray-900">Registration Deadline</h3>
                                <p class="text-gray-600">{{ campaign.registration_deadline|date:"M d, Y" }} at {{ campaign.registration_deadline|time:"g:i A" }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Contact Information -->
                {% if campaign.contact_phone or campaign.contact_email %}
                <div class="info-card">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Contact Information</h2>
                    <div class="space-y-3">
                        {% if campaign.contact_phone %}
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìû</span>
                            <div>
                                <span class="font-semibold">Phone:</span>
                                <a href="tel:{{ campaign.contact_phone }}" class="text-blue-600 hover:text-blue-800 ml-2">
                                    {{ campaign.contact_phone }}
                                </a>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if campaign.contact_email %}
                        <div class="flex items-center gap-3">
                            <span class="text-xl">üìß</span>
                            <div>
                                <span class="font-semibold">Email:</span>
                                <a href="mailto:{{ campaign.contact_email }}" class="text-blue-600 hover:text-blue-800 ml-2">
                                    {{ campaign.contact_email }}
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Recent Participants -->
                {% if recent_participants %}
                <div class="info-card">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Recent Participants</h2>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex -space-x-2">
                            {% for participant in recent_participants|slice:":8" %}
                            <div class="participant-avatar bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center text-white font-bold text-sm"
                                 title="{{ participant.user.get_full_name|default:participant.user.username }}">
                                {{ participant.user.get_full_name|default:participant.user.username|first|upper }}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="text-gray-600">
                            <span class="font-semibold">{{ campaign.participant_count }}</span> 
                            participant{{ campaign.participant_count|pluralize }} joined
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                
                <!-- Registration Form -->
                {% if user_participation %}
                <div class="bg-green-100 border border-green-200 rounded-xl p-6">
                    <div class="text-center">
                        <div class="text-4xl mb-3">‚úÖ</div>
                        <h3 class="text-xl font-bold text-green-900 mb-2">You're Registered!</h3>
                        <p class="text-green-700 mb-4">
                            Status: {{ user_participation.get_interest_level_display }}
                        </p>
                        <p class="text-sm text-green-600">
                            Registered on {{ user_participation.registered_at|date:"M d, Y" }}
                        </p>
                        
                        {% if campaign.is_upcoming %}
                        <div class="mt-4 p-3 bg-green-50 rounded-lg">
                            <p class="text-sm text-green-700">
                                üì± You'll receive WhatsApp/SMS reminders 3 days and 1 day before the campaign!
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% elif campaign.can_register %}
                <div class="join-form">
                    <h3 class="text-2xl font-bold mb-4">Join This Campaign</h3>
                    <p class="text-blue-100 mb-6">
                        Select your participation level and help make a difference in your community!
                    </p>
                    
                    <form method="post" action="{% url 'community:join_campaign' campaign.id %}">
                        {% csrf_token %}
                        
                        <div class="space-y-3 mb-6">
                            <label class="interest-option block cursor-pointer">
                                <input type="radio" name="interest_level" value="join" class="sr-only" checked>
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">‚úÖ</span>
                                    <div>
                                        <div class="font-semibold">I will join</div>
                                        <div class="text-sm text-blue-100">Committed to participate</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="interest-option block cursor-pointer">
                                <input type="radio" name="interest_level" value="interested" class="sr-only">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">üëç</span>
                                    <div>
                                        <div class="font-semibold">I'm interested</div>
                                        <div class="text-sm text-blue-100">Want to stay updated</div>
                                    </div>
                                </div>
                            </label>
                            
                            <label class="interest-option block cursor-pointer">
                                <input type="radio" name="interest_level" value="maybe" class="sr-only">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ü§î</span>
                                    <div>
                                        <div class="font-semibold">Maybe</div>
                                        <div class="text-sm text-blue-100">Still deciding</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <button type="submit" 
                                class="w-full bg-white text-blue-600 px-6 py-3 rounded-lg font-bold hover:bg-blue-50 transition-colors">
                            Register Now
                        </button>
                    </form>
                    
                    <p class="text-xs text-blue-100 mt-4 text-center">
                        üì± You'll receive automatic reminders via WhatsApp/SMS
                    </p>
                </div>
                
                {% else %}
                <div class="bg-gray-100 border border-gray-200 rounded-xl p-6 text-center">
                    <div class="text-4xl mb-3">‚è∞</div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Registration Closed</h3>
                    <p class="text-gray-600">
                        {% if campaign.is_full %}
                        This campaign has reached its maximum capacity.
                        {% elif campaign.is_past %}
                        This campaign has already ended.
                        {% else %}
                        Registration deadline has passed.
                        {% endif %}
                    </p>
                </div>
                {% endif %}

                <!-- Campaign Stats -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Campaign Stats</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Participants</span>
                            <span class="font-bold text-green-600">{{ campaign.participant_count }}</span>
                        </div>
                        {% if campaign.max_participants %}
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Capacity</span>
                            <span class="font-bold">{{ campaign.max_participants }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            {% if campaign.max_participants %}
                                {% widthratio campaign.participant_count campaign.max_participants 100 as percentage %}
                                <div class="bg-green-500 h-2 rounded-full" style="width: {{ percentage }}%"></div>
                            {% else %}
                                <div class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Type</span>
                            <span class="font-bold">{{ campaign.get_campaign_type_display }}</span>
                        </div>
                        {% if campaign.recurrence != 'one_time' %}
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Frequency</span>
                            <span class="font-bold">{{ campaign.get_recurrence_display }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Share Campaign -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Share Campaign</h3>
                    <div class="flex gap-2">
                        <a href="https://wa.me/?text=Join%20{{ campaign.title|urlencode }}%20on%20{{ campaign.start_date|date:'M d, Y' }}%20at%20{{ campaign.location|urlencode }}%20{{ request.build_absolute_uri }}" 
                           target="_blank"
                           class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-center font-semibold transition-colors">
                            WhatsApp
                        </a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}" 
                           target="_blank"
                           class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-center font-semibold transition-colors">
                            Facebook
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Handle interest level selection
document.querySelectorAll('input[name="interest_level"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // Remove selected class from all options
        document.querySelectorAll('.interest-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Add selected class to chosen option
        this.closest('.interest-option').classList.add('selected');
    });
});

// Set initial selection
document.querySelector('input[name="interest_level"]:checked').closest('.interest-option').classList.add('selected');
</script>
{% endblock %}