{% extends 'base.html' %}
{% load static %}

{% block title %}AI Assistant - EcoLearn{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="h-screen flex flex-col">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-eco-green to-eco-dark p-4 text-white shadow-lg flex-shrink-0">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">EcoLearn AI Assistant</h1>
                    <p class="text-white/90">Your environmental learning companion</p>
                </div>
            </div>
        </div>
        
        <!-- Chat Container -->
        <div class="flex-1 flex flex-col bg-white">
            
            <!-- Messages Area -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 bg-gradient-to-b from-gray-50 to-white">
                <!-- Welcome Message -->
                <div id="welcome-message" class="text-center py-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-eco-green to-eco-dark rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-leaf text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Welcome to EcoLearn AI!</h3>
                    <p class="text-gray-600 text-lg mb-6">I'm here to help you with environmental practices, waste management, and navigating the platform.</p>
                    
                    <!-- Quick Action Buttons -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                        <button onclick="askQuestion('How do I report illegal dumping?')" 
                                class="bg-white border-2 border-eco-green/20 hover:border-eco-green hover:bg-eco-light p-4 rounded-lg transition-all duration-300 text-left group">
                            <i class="fas fa-flag text-eco-green mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-semibold text-gray-800">Report Illegal Dumping</h4>
                            <p class="text-sm text-gray-600">Learn how to report waste violations</p>
                        </button>
                        
                        <button onclick="askQuestion('What learning modules are available?')" 
                                class="bg-white border-2 border-eco-green/20 hover:border-eco-green hover:bg-eco-light p-4 rounded-lg transition-all duration-300 text-left group">
                            <i class="fas fa-graduation-cap text-eco-green mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-semibold text-gray-800">Learning Modules</h4>
                            <p class="text-sm text-gray-600">Discover available courses</p>
                        </button>
                        
                        <button onclick="askQuestion('How do I join a cleanup group?')" 
                                class="bg-white border-2 border-eco-green/20 hover:border-eco-green hover:bg-eco-light p-4 rounded-lg transition-all duration-300 text-left group">
                            <i class="fas fa-users text-eco-green mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-semibold text-gray-800">Join Community Groups</h4>
                            <p class="text-sm text-gray-600">Connect with local activists</p>
                        </button>
                        
                        <button onclick="askQuestion('Tell me about recycling best practices')" 
                                class="bg-white border-2 border-eco-green/20 hover:border-eco-green hover:bg-eco-light p-4 rounded-lg transition-all duration-300 text-left group">
                            <i class="fas fa-recycle text-eco-green mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-semibold text-gray-800">Recycling Tips</h4>
                            <p class="text-sm text-gray-600">Learn waste management</p>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typing-indicator" class="px-6 py-3 hidden border-t border-gray-100">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-eco-green rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-eco-green rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-eco-green rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="ml-3 text-gray-600">AI is thinking...</span>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="p-4 border-t border-gray-100 bg-white flex-shrink-0">
                <div class="flex space-x-3">
                    <textarea 
                        id="chat-input" 
                        class="flex-1 p-3 border-2 border-gray-200 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-eco-green focus:border-transparent transition-all duration-300 bg-gray-50 focus:bg-white"
                        placeholder="Ask me anything about EcoLearn, waste management, or environmental practices..."
                        rows="1"
                    ></textarea>
                    <button 
                        id="send-button" 
                        class="bg-gradient-to-r from-eco-green to-eco-dark text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-eco-green focus:ring-offset-2"
                    >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-3 flex flex-wrap gap-2 justify-center">
                    <button onclick="askQuestion('How do I report illegal dumping?')" 
                            class="text-xs bg-eco-light text-eco-dark px-3 py-1 rounded-full hover:bg-eco-green hover:text-white transition-all">
                        Report Dumping
                    </button>
                    <button onclick="askQuestion('What learning modules are available?')" 
                            class="text-xs bg-eco-light text-eco-dark px-3 py-1 rounded-full hover:bg-eco-green hover:text-white transition-all">
                        Learning Modules
                    </button>
                    <button onclick="askQuestion('How do I join a cleanup group?')" 
                            class="text-xs bg-eco-light text-eco-dark px-3 py-1 rounded-full hover:bg-eco-green hover:text-white transition-all">
                        Join Groups
                    </button>
                    <button onclick="startNewChat()" 
                            class="text-xs bg-gray-200 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-300 transition-all">
                        <i class="fas fa-plus mr-1"></i>New Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSessionId = null;
let isLoading = false;

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    
    // Auto-resize textarea
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Handle Enter key
    input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });
    
    // Send button click
    sendButton.addEventListener('click', sendMessage);
    
    // Focus input
    input.focus();
});

// Send message function
async function sendMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (!message || isLoading) return;
    
    // Clear input and update UI
    input.value = '';
    input.style.height = 'auto';
    isLoading = true;
    updateSendButton();
    
    // Add user message to chat
    addMessage('user', message);
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
        console.log('Sending message:', message);
        console.log('Session ID:', currentSessionId);
        
        const response = await fetch('/ai-assistant/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message,
                session_id: currentSessionId
            })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            currentSessionId = data.session_id;
            addMessage('assistant', data.assistant_message.content);
        } else {
            console.error('API Error:', data.error);
            addMessage('assistant', 'Sorry, I encountered an error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Fetch Error:', error);
        
        // Provide more helpful error messages
        let errorMessage = 'Sorry, I\'m having trouble connecting right now. ';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage += 'Please check your internet connection and try again.';
        } else if (error.message.includes('500')) {
            errorMessage += 'There\'s a server issue. Please try again in a moment.';
        } else if (error.message.includes('404')) {
            errorMessage += 'The service endpoint wasn\'t found. Please refresh the page.';
        } else {
            errorMessage += 'Please refresh the page and try again. If the problem persists, contact support.';
        }
        
        addMessage('assistant', errorMessage);
    } finally {
        hideTypingIndicator();
        isLoading = false;
        updateSendButton();
        input.focus();
    }
}

// Add message to chat
function addMessage(role, content) {
    const messagesContainer = document.getElementById('chat-messages');
    
    // Remove welcome message on first user message
    const welcomeMessage = document.getElementById('welcome-message');
    if (welcomeMessage && role === 'user') {
        welcomeMessage.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex mb-6 ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;
    
    const avatarBg = role === 'user' ? 
        'bg-gradient-to-br from-eco-green to-eco-dark' : 
        'bg-gradient-to-br from-blue-500 to-blue-600';
    
    const messageBg = role === 'user' ? 
        'bg-gradient-to-br from-eco-green to-eco-dark text-white' : 
        'bg-white text-gray-800 border border-gray-200 shadow-sm';
    
    const messageOrder = role === 'user' ? 'flex-row-reverse' : 'flex-row';
    const avatarMargin = role === 'user' ? 'ml-3' : 'mr-3';
    
    messageDiv.innerHTML = `
        <div class="flex max-w-xs lg:max-w-md ${messageOrder}">
            <div class="w-10 h-10 ${avatarBg} rounded-full flex items-center justify-center ${avatarMargin} flex-shrink-0">
                <i class="fas ${role === 'user' ? 'fa-user' : 'fa-robot'} text-white"></i>
            </div>
            <div class="${messageBg} p-4 rounded-2xl ${role === 'user' ? 'rounded-br-md' : 'rounded-bl-md'}">
                ${formatMessage(content)}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Format message content
function formatMessage(content) {
    // Convert line breaks to <br>
    content = content.replace(/\n/g, '<br>');
    
    // Convert URLs to links
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    content = content.replace(urlRegex, '<a href="$1" target="_blank" class="text-eco-green underline hover:text-eco-dark">$1</a>');
    
    return content;
}

// Show/hide typing indicator
function showTypingIndicator() {
    document.getElementById('typing-indicator').classList.remove('hidden');
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typing-indicator').classList.add('hidden');
}

// Update send button state
function updateSendButton() {
    const button = document.getElementById('send-button');
    button.disabled = isLoading;
    
    if (isLoading) {
        button.innerHTML = '<i class="fas fa-spinner fa-spin text-lg"></i>';
        button.classList.add('opacity-75');
    } else {
        button.innerHTML = '<i class="fas fa-paper-plane text-lg"></i>';
        button.classList.remove('opacity-75');
    }
}

// Quick question function
function askQuestion(question) {
    const input = document.getElementById('chat-input');
    input.value = question;
    input.focus();
    sendMessage();
}

// Start new chat
async function startNewChat() {
    try {
        const response = await fetch('/ai-assistant/session/new/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentSessionId = data.session_id;
            
            // Clear messages and show welcome message
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div id="welcome-message" class="text-center py-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-eco-green to-eco-dark rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-leaf text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Welcome to EcoLearn AI!</h3>
                    <p class="text-gray-600 text-lg mb-6">I'm here to help you with environmental practices, waste management, and navigating the platform.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
                        <button onclick="askQuestion('How do I report illegal dumping?')" 
                                class="bg-white border-2 border-eco-green/20 hover:border-eco-green hover:bg-eco-light p-4 rounded-lg transition-all duration-300 text-left group">
                            <i class="fas fa-flag text-eco-green mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-semibold text-gray-800">Report Illegal Dumping</h4>
                            <p class="text-sm text-gray-600">Learn how to report waste violations</p>
                        </button>
                        
                        <button onclick="askQuestion('What learning modules are available?')" 
                                class="bg-white border-2 border-eco-green/20 hover:border-eco-green hover:bg-eco-light p-4 rounded-lg transition-all duration-300 text-left group">
                            <i class="fas fa-graduation-cap text-eco-green mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-semibold text-gray-800">Learning Modules</h4>
                            <p class="text-sm text-gray-600">Discover available courses</p>
                        </button>
                        
                        <button onclick="askQuestion('How do I join a cleanup group?')" 
                                class="bg-white border-2 border-eco-green/20 hover:border-eco-green hover:bg-eco-light p-4 rounded-lg transition-all duration-300 text-left group">
                            <i class="fas fa-users text-eco-green mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-semibold text-gray-800">Join Community Groups</h4>
                            <p class="text-sm text-gray-600">Connect with local activists</p>
                        </button>
                        
                        <button onclick="askQuestion('Tell me about recycling best practices')" 
                                class="bg-white border-2 border-eco-green/20 hover:border-eco-green hover:bg-eco-light p-4 rounded-lg transition-all duration-300 text-left group">
                            <i class="fas fa-recycle text-eco-green mb-2 group-hover:scale-110 transition-transform"></i>
                            <h4 class="font-semibold text-gray-800">Recycling Tips</h4>
                            <p class="text-sm text-gray-600">Learn waste management</p>
                        </button>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error starting new chat:', error);
    }
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Test AI connection on page load
async function testConnection() {
    try {
        const response = await fetch('/ai-assistant/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: 'test',
                session_id: null
            })
        });
        
        if (response.ok) {
            console.log('✅ AI Assistant connection successful');
        } else {
            console.warn('⚠️ AI Assistant connection issue:', response.status);
        }
    } catch (error) {
        console.error('❌ AI Assistant connection failed:', error);
        
        // Show connection warning in UI
        const messagesContainer = document.getElementById('chat-messages');
        const welcomeMessage = document.getElementById('welcome-message');
        
        if (welcomeMessage) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4 max-w-2xl mx-auto';
            warningDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                    <div>
                        <h4 class="font-semibold text-yellow-800">Connection Issue</h4>
                        <p class="text-sm text-yellow-700">I'm having trouble connecting. Please refresh the page or try again later.</p>
                    </div>
                </div>
            `;
            welcomeMessage.appendChild(warningDiv);
        }
    }
}

// Run connection test when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(testConnection, 1000); // Test after 1 second
});
</script>

<style>
/* Custom animations */
@keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fade-in 0.3s ease-out;
}

/* Custom scrollbar */
#chat-messages::-webkit-scrollbar {
    width: 6px;
}

#chat-messages::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: #22c55e;
    border-radius: 3px;
}

#chat-messages::-webkit-scrollbar-thumb:hover {
    background: #16a34a;
}
</style>
{% endblock %}