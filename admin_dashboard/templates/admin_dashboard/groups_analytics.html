{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}Groups Analytics{% endblock %}
{% block page_title %}Groups Analytics & Insights{% endblock %}

{% block content %}
<div class="space-y-8">
    
    <!-- Back Button -->
    <div class="flex items-center space-x-4">
        <a href="{% url 'admin_dashboard:groups_management' %}" class="flex items-center text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
            <i class="fas fa-arrow-left mr-2"></i>Back to Groups Management
        </a>
    </div>

    <!-- Group Growth Chart -->
    <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-zinc-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Group Growth Over Time</h3>
        <div class="h-64">
            <canvas id="groupGrowthChart"></canvas>
        </div>
    </div>

    <!-- Social Media Adoption -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-zinc-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Social Media Adoption</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fab fa-facebook-f text-blue-600 text-xl"></i>
                        <span class="text-gray-900 dark:text-white">Facebook</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-32 bg-gray-200 dark:bg-zinc-700 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: {% widthratio social_stats.facebook 100 100 %}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900 dark:text-white w-8">{{ social_stats.facebook }}</span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fab fa-whatsapp text-green-600 text-xl"></i>
                        <span class="text-gray-900 dark:text-white">WhatsApp</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-32 bg-gray-200 dark:bg-zinc-700 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: {% widthratio social_stats.whatsapp 100 100 %}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900 dark:text-white w-8">{{ social_stats.whatsapp }}</span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fab fa-x-twitter text-gray-900 dark:text-white text-xl"></i>
                        <span class="text-gray-900 dark:text-white">X (Twitter)</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-32 bg-gray-200 dark:bg-zinc-700 rounded-full h-2">
                            <div class="bg-gray-900 dark:bg-white h-2 rounded-full" style="width: {% widthratio social_stats.twitter 100 100 %}%"></div>
                        </div>
                        <span class="text-sm font-medium text-gray-900 dark:text-white w-8">{{ social_stats.twitter }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Group Size Distribution -->
        <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-zinc-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Group Size Distribution</h3>
            <div class="h-64">
                <canvas id="groupSizeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- District Impact Analysis -->
    <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-zinc-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Impact by District</h3>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 dark:bg-zinc-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">District</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Groups</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Events</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Waste Collected</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Participants</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Avg per Group</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-zinc-800 divide-y divide-gray-200 dark:divide-zinc-700">
                    {% for district in district_impact %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{ district.district }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ district.group_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ district.total_events|default:0 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600 dark:text-orange-400">{{ district.total_waste|default:0|floatformat:1 }}kg</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">{{ district.total_participants|default:0 }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            {{ district.avg_waste_per_group }}kg
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Top Coordinators -->
    <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-zinc-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Most Active Coordinators</h3>
        <div class="space-y-4">
            {% for coordinator in active_coordinators %}
            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-zinc-700 rounded-lg">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-zm-green rounded-full flex items-center justify-center text-white font-bold">
                        {{ forloop.counter }}
                    </div>
                    <div>
                        <div class="font-medium text-gray-900 dark:text-white">
                            {{ coordinator.coordinator__first_name }} {{ coordinator.coordinator__last_name|default:coordinator.coordinator__username }}
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">{{ coordinator.groups_count }} group{{ coordinator.groups_count|pluralize }}</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold text-orange-600 dark:text-orange-400">{{ coordinator.total_impact|default:0|floatformat:1 }}kg</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">{{ coordinator.total_events|default:0 }} events</div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                <i class="fas fa-user-tie text-4xl mb-4"></i>
                <p>No coordinator data available</p>
            </div>
            {% endfor %}
        </div>
    </div>

</div>

<script>
// Group Growth Chart
const growthCtx = document.getElementById('groupGrowthChart').getContext('2d');
new Chart(growthCtx, {
    type: 'line',
    data: {
        labels: [{% for month in monthly_growth %}'{{ month.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'New Groups',
            data: [{% for month in monthly_growth %}{{ month.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// Group Size Distribution Chart
const sizeCtx = document.getElementById('groupSizeChart').getContext('2d');
new Chart(sizeCtx, {
    type: 'doughnut',
    data: {
        labels: ['Small (< 10)', 'Medium (10-25)', 'Large (25+)'],
        datasets: [{
            data: [{{ size_distribution.small }}, {{ size_distribution.medium }}, {{ size_distribution.large }}],
            backgroundColor: ['#f59e0b', '#3b82f6', '#22c55e'],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}