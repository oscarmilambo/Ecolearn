{% extends 'admin_dashboard/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ challenge.title }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="text-sm text-gray-500 dark:text-gray-400">
        <a href="{% url 'admin_dashboard:challenge_management' %}" class="hover:text-zm-green">{% trans "Challenges" %}</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900 dark:text-white">{{ challenge.title }}</span>
    </nav>

    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-trophy text-yellow-500 mr-2"></i>{{ challenge.title }}
            </h2>
            <p class="text-gray-600 dark:text-gray-400 mt-2">{{ challenge.description }}</p>
        </div>
        <a href="{% url 'admin_dashboard:challenge_management' %}" 
           class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition">
            <i class="fas fa-arrow-left mr-2"></i>{% trans "Back" %}
        </a>
    </div>

    <!-- Challenge Image -->
    {% if challenge.image %}
    <div class="rounded-xl overflow-hidden shadow-lg">
        <img src="{{ challenge.image.url }}" alt="{{ challenge.title }}" class="w-full h-64 object-cover">
    </div>
    {% endif %}

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-lg">
            <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Participants" %}</p>
            <h3 class="text-3xl font-bold text-gray-900 dark:text-white mt-2">{{ participants.count }}</h3>
        </div>
        <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-lg">
            <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Progress" %}</p>
            <h3 class="text-3xl font-bold text-zm-green mt-2">{{ progress_percentage }}%</h3>
        </div>
        <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-lg">
            <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Contribution" %}</p>
            <h3 class="text-3xl font-bold text-gray-900 dark:text-white mt-2">{{ total_contribution }}</h3>
        </div>
        <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-lg">
            <p class="text-sm text-gray-500 dark:text-gray-400">{% trans "Reward" %}</p>
            <h3 class="text-3xl font-bold text-yellow-500 mt-2">{{ challenge.reward_points }} pts</h3>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="bg-white dark:bg-zinc-800 rounded-xl p-6 shadow-lg">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">{% trans "Challenge Progress" %}</h3>
        <div class="w-full bg-gray-200 dark:bg-zinc-700 rounded-full h-6">
            <div class="bg-zm-green h-6 rounded-full flex items-center justify-center text-white text-sm font-medium" 
                 style="width: {{ progress_percentage }}%">
                {{ progress_percentage }}%
            </div>
        </div>
        <p class="text-gray-600 dark:text-gray-400 mt-2">
            {{ total_contribution }} / {{ challenge.target_goal }} ({{ participants.count }} {% trans "participants" %})
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Participants List -->
        <div class="lg:col-span-2 bg-white dark:bg-zinc-800 rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-zinc-700">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                    <i class="fas fa-users mr-2"></i>{% trans "Participants" %} ({{ participants.count }})
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-zinc-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">{% trans "Participant" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">{% trans "Contribution" %}</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">{% trans "Joined" %}</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-zinc-700">
                        {% for participant in participants %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-zinc-700">
                            <td class="px-6 py-4">
                                <a href="{% url 'admin_dashboard:user_detail' participant.user.id %}" 
                                   class="text-zm-green hover:text-green-600 font-medium">
                                    {{ participant.user.get_full_name|default:participant.user.username }}
                                </a>
                            </td>
                            <td class="px-6 py-4 font-bold text-gray-900 dark:text-white">{{ participant.contribution }}</td>
                            <td class="px-6 py-4 text-gray-600 dark:text-gray-400">{{ participant.joined_at|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                                {% trans "No participants yet" %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Actions Sidebar -->
        <div class="space-y-6">
            <!-- Edit Form -->
            <div class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                    <i class="fas fa-edit mr-2"></i>{% trans "Edit Challenge" %}
                </h3>
                <form method="post" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{% trans "Title" %}</label>
                        <input type="text" name="title" value="{{ challenge.title }}" 
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{% trans "Description" %}</label>
                        <textarea name="description" rows="3" 
                                  class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white" required>{{ challenge.description }}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{% trans "Target Goal" %}</label>
                        <input type="number" name="target_goal" value="{{ challenge.target_goal }}" 
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{% trans "Reward Points" %}</label>
                        <input type="number" name="reward_points" value="{{ challenge.reward_points }}" 
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{% trans "Image" %}</label>
                        <input type="file" name="image" accept="image/*"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white">
                    </div>

                    <button type="submit" class="w-full bg-zm-green hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition">
                        <i class="fas fa-save mr-2"></i>{% trans "Update" %}
                    </button>
                </form>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                    <i class="fas fa-bolt mr-2"></i>{% trans "Quick Actions" %}
                </h3>
                <div class="space-y-3">
                    <!-- Toggle Status -->
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="toggle_status">
                        <button type="submit" class="w-full {% if challenge.is_active %}bg-yellow-500 hover:bg-yellow-600{% else %}bg-green-500 hover:bg-green-600{% endif %} text-white px-4 py-2 rounded-lg font-medium transition">
                            <i class="fas fa-{% if challenge.is_active %}pause{% else %}play{% endif %} mr-2"></i>
                            {% if challenge.is_active %}{% trans "Cancel" %}{% else %}{% trans "Activate" %}{% endif %}
                        </button>
                    </form>

                    <!-- Award Points -->
                    {% if challenge.end_date < now %}
                    <form method="post" onsubmit="return confirm('{% trans "Award points to all participants?" %}');">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="award_points">
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">
                            <i class="fas fa-gift mr-2"></i>{% trans "Award Points" %}
                        </button>
                    </form>
                    {% endif %}

                    <!-- Delete -->
                    <a href="{% url 'admin_dashboard:challenge_delete' challenge.id %}" 
                       onclick="return confirm('{% trans "Delete this challenge?" %}');"
                       class="block w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition text-center">
                        <i class="fas fa-trash mr-2"></i>{% trans "Delete" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
